# 4. 로그인 구현 with Spring Security





### 회원 가입

회원 가입은 스프링 시큐리티 없이 구현할 수 있다. 단, 여기서 이전 로그인 구현과 다른 점은 도메인단에

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption><p>Join</p></figcaption></figure>

* **도메인단** : `User`, `UserRole`, `UserJoinRequest`

```java
// User
@Table(name = "user")
public class User implements UserDetails {

    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "user_id")
    private Long id;

    private String name;

    private String password;

    @Column
    @Enumerated(EnumType.STRING)
    private UserRole userRole;

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        Set<GrantedAuthority> roles = new HashSet<>();
        roles.add(new SimpleGrantedAuthority(userRole.getValue()));
        return roles;
    }

    @Override
    public String getPassword() {
        return this.password;
    }

    @Override
    public String getUsername() {
        return this.name;
    }

    @Override // 만료 계정인지
    public boolean isAccountNonExpired() {
        return true;
    }

    @Override // 잠긴 계정인지
    public boolean isAccountNonLocked() {
        return true;
    }

    @Override // 비밀번호 만료되었는지
    public boolean isCredentialsNonExpired() {
        return true;
    }

    @Override // 계정 활성화 여부
    public boolean isEnabled() {
        return true;
    }
}
```

* UserRole

```java
public enum UserRole {
    USER("ROLE_USER"),
    ADMIN("ROLE_ADMIN");

    private String value;
}
```

* UserJoinRequest

```java
public class UserJoinRequest {
    @NotNull
    private String name;

    private String email;

    @NotNull
    private String password;

    @NotNull
    private UserRole userRole;
}
```

이때 UserRole을 통해 권한 설정

* **서비스단** : `UserService`

```java
public class UserService {

    private final UserRepository userRepository;
    private final BCryptPasswordEncoder bCryptPasswordEncoder;

    public User createUser(UserJoinRequest userJoinRequest) {
        User user = userRepository.save(
                User.builder()
                        .name(userJoinRequest.getName())
                        .userRole(userJoinRequest.getUserRole())
                        .password(bCryptPasswordEncoder.encode(userJoinRequest.getPassword())).build());
        return user;
    }
}
```

* **레포지토리단** : `UserRepository`

```java
@Repository
public interface UserRepository extends JpaRepository<User, Integer> {
    public User findByName(String name);
}
```

* 컨트롤러단 :

```java
@RestController
@RequiredArgsConstructor
public class UserController {

    private final UserService usersService;

    @PostMapping("/join")
    public void createUser(UserJoinRequest userJoinRequest, HttpServletResponse response) throws IOException {
        usersService.createUser(userJoinRequest);
        response.sendRedirect("/login");
    }
}
```

{% embed url="https://github.com/f-lab-edu/book-club/commit/cf7f79580b9b44a0e8c4721f6f95241587caacb1" %}



### 로그인/로그아웃

스프링 시큐리티는 일종의 필터체인이라고 할 수 있다. Config 파일을 통해서 해당 어플리케이션의 모든 요청을 낚아채서 먼저 로그인하게 만들었다.

<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption><p>Login</p></figcaption></figure>

* config

```java
@EnableWebSecurity // SpringSecurityFilterChain 에 등록
@RequiredArgsConstructor
public class SpringSecurityConfig extends WebSecurityConfigurerAdapter {

    private final UserDetailsService userDetailsService;

    // 인증에서 제외
    @Override
    public void configure(WebSecurity web) throws Exception {
        web.ignoring().antMatchers("/css/**", "/script/**", "/image/**", "/fonts/**", "lib/**");
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.csrf().disable().authorizeRequests()
                .antMatchers("/login", "/join").permitAll()     // 모두 접근 가능
                .antMatchers("/admin").hasRole("ADMIN")         // ADMIN 만 접근 가능
                .antMatchers("/main").authenticated()           // 인증해야 접근 가능
                /* 로그인 폼 */
                .and().formLogin()
                .loginPage("/login")
                .usernameParameter("name")
                .passwordParameter("password")
                .defaultSuccessUrl("/main")
                .failureUrl("/fail")
                .permitAll()
                /* 로그아웃 */
                .and().logout()
                .logoutUrl("/logout")
                .logoutSuccessUrl("/login")
                .deleteCookies("JSESSIONID")
                .invalidateHttpSession(true)
                .permitAll();
    }

    @Bean
    public BCryptPasswordEncoder bCryptPasswordEncoder() {
        return new BCryptPasswordEncoder();
    }

    // Manager 에 Provider 등록
    @Override
    public void configure(AuthenticationManagerBuilder authenticationManagerBuilder) throws Exception {
        authenticationManagerBuilder.authenticationProvider(customAuthenticationProvider());
    }

    // Provider 생성
    @Bean
    public CustomAuthenticationProvider customAuthenticationProvider() {
        return new CustomAuthenticationProvider(userDetailsService, bCryptPasswordEncoder());
    }
}
```

* HomeController

```java
@Controller
@RequiredArgsConstructor
public class HomeController {

        private final UserRepository userRepository;

        @GetMapping(value = {"/", "/login"})
        String login() {
        return "login";
        }

        @GetMapping("/fail")
        String fail() {
            return "fail";
        }

        @GetMapping("/join")
        String join() {
            return "join";
        }

        @GetMapping("/admin")
        ModelAndView adminModel(Authentication authentication) {
            User user = Optional.ofNullable(userRepository.findByName(authentication.getName()))
                    .map(u -> User.builder().name(u.getName()).password(u.getPassword()).userRole(u.getUserRole()).build())
                    .orElseThrow(IllegalArgumentException::new);

            ModelAndView modelAndView = new ModelAndView("/admin");
            modelAndView.addObject("user", user);

            return modelAndView;
        }

        @GetMapping(value ="/main")
        ModelAndView mainModel(Authentication authentication) {
            User user = Optional.ofNullable(userRepository.findByName(authentication.getName()))
                    .map(u -> User.builder().name(u.getName()).password(u.getPassword()).userRole(u.getUserRole()).build())
                    .orElseThrow(IllegalArgumentException::new);

            ModelAndView modelAndView = new ModelAndView("/main");
            modelAndView.addObject("user", user);

            return modelAndView;
        }
    }
```

* AuthenticationProvider :

```java
@RequiredArgsConstructor
public class CustomAuthenticationProvider implements AuthenticationProvider {

    private final UserDetailsService userDetailsService;

    private final BCryptPasswordEncoder passwordEncoder;

    // 인증 메소드
    @Override
    public Authentication authenticate(Authentication authentication) throws AuthenticationException {

        String name = authentication.getName();
        String password = (String) authentication.getCredentials();

        User user = (User) userDetailsService.loadUserByUsername(name);

        if (!passwordEncoder.matches(password, user.getPassword())) {
            throw new BadCredentialsException(user.getUsername() + "비밀번호를 다시 입력해주세요.");
        }
        return new UsernamePasswordAuthenticationToken(user, user.getPassword(), user.getAuthorities());
    }

    @Override
    public boolean supports(Class<?> authentication) {
        return authentication.equals(UsernamePasswordAuthenticationToken.class);
    }
}
```

* UserDetailsService :

```java
public class CustomUserDetailsService implements UserDetailsService {

    private final UserRepository userRepository;

    @Override
    public UserDetails loadUserByUsername(String name) {

        User user = userRepository.findByName(name);
        if (user == null) {
            throw new UsernameNotFoundException("Can't find user");
        }
        return user;
    }
}
```



